# OKOME Frontend Cache Node — Hardened, path through OKOME (192.168.86.25) only
# Location: /etc/nginx/sites-available/okome-frontend
# Node: 192.168.86.20
# All traffic through OKOME at .25; health-gated failover, rate limits, full throughput + failure handling.

proxy_cache_path /var/cache/nginx/okome
    levels=1:2
    keys_zone=OKOME_FRONTEND:100m
    max_size=2g
    inactive=24h
    use_temp_path=off;

limit_req_zone $binary_remote_addr zone=okome_ui:10m rate=20r/s;
limit_req_zone $binary_remote_addr zone=okome_api:10m rate=10r/s;
limit_conn_zone $binary_remote_addr zone=okome_conn:10m;

# Single upstream: OKOME at 192.168.86.25 (path through OKOME only)
upstream okome_upstream {
    server 192.168.86.25:8000 max_fails=3 fail_timeout=10s;
    keepalive 64;
}

server {
    listen 80;
    server_name _;

    include /etc/nginx/okome/health_state.conf;

    add_header X-OKOME-Node frontend-cache always;
    add_header X-Cache-Status $upstream_cache_status always;
    add_header X-Upstream $upstream_addr always;
    add_header X-Upstream-Status $upstream_status always;
    add_header X-Request-ID $request_id always;

    set $okome_failover 0;
    if ($okome_upstream_ok = 0) { set $okome_failover 1; }

    location @okome_maintenance {
        add_header Cache-Control "no-store" always;
        add_header Retry-After 30 always;
        default_type text/plain;
        return 503 "OKOME (192.168.86.25) unhealthy. Serving maintenance.\n";
    }

    # ---------- API / STREAMING — through OKOME .25, unbuffered, full throughput ----------
    location ~* ^/(v1/|api/|execute|agent|run|ws) {
        limit_conn okome_conn 50;
        limit_req zone=okome_api burst=20 nodelay;

        proxy_pass http://okome_upstream;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";

        proxy_buffering off;
        proxy_request_buffering off;
        proxy_cache off;
        chunked_transfer_encoding on;
        add_header Cache-Control "no-store" always;

        proxy_connect_timeout 5s;
        proxy_read_timeout 600s;
        proxy_send_timeout 600s;

        proxy_next_upstream error timeout http_502 http_503 http_504;
        proxy_next_upstream_tries 2;
        proxy_next_upstream_timeout 10s;
    }

    # ---------- STATIC UI — cache, health-gated stale/maintenance ----------
    location / {
        limit_conn okome_conn 30;
        limit_req zone=okome_ui burst=60 nodelay;

        proxy_pass http://okome_upstream;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Connection "";

        proxy_cache OKOME_FRONTEND;
        proxy_cache_valid 200 24h;
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
        proxy_cache_lock on;
        proxy_cache_lock_timeout 5s;
        expires 24h;

        proxy_connect_timeout 5s;
        proxy_read_timeout 60s;
        proxy_send_timeout 60s;

        proxy_intercept_errors on;
        error_page 502 503 504 = @okome_maintenance;
    }

    # ---------- ASSETS ----------
    location ~* ^/(assets|static|ui-schema)/ {
        limit_req zone=okome_ui burst=120 nodelay;
        access_log off;

        proxy_pass http://okome_upstream;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header Connection "";

        proxy_cache OKOME_FRONTEND;
        proxy_cache_valid 200 7d;
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
        expires 7d;

        proxy_connect_timeout 5s;
        proxy_read_timeout 30s;
    }

    # ---------- VERSION / HEALTH ----------
    location ~* ^/(version|health)$ {
        proxy_pass http://okome_upstream;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header Connection "";

        proxy_cache OKOME_FRONTEND;
        proxy_cache_valid 200 30s;
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;

        proxy_connect_timeout 3s;
        proxy_read_timeout 5s;
    }

    # ---------- NGINX STATUS (LAN only) ----------
    location /nginx_status {
        stub_status;
        allow 192.168.86.0/24;
        deny all;
    }

    log_format okome '$remote_addr - $request_id [$time_local] '
                     '"$request" $status $body_bytes_sent '
                     'cache=$upstream_cache_status upstream=$upstream_addr '
                     'urt=$upstream_response_time rt=$request_time';
    access_log /var/log/nginx/okome_access.log okome;
    error_log  /var/log/nginx/okome_error.log warn;
}
