# Canary cache policies for specific endpoints
# Include this in server block after canary_maps.conf
#
# Example: ui-schema canary policy (shorter TTL to validate schema churn)
location ~* ^/ui-schema/ {
    proxy_pass http://okome_orchestrator;

    # Canary behavior
    if ($okome_canary_mode = "debug") {
        proxy_no_cache 1;
        proxy_cache_bypass 1;
        add_header X-OKOME-Canary "debug-bypass" always;
        break;
    }

    proxy_cache OKOME_FRONTEND;

    # Control TTL
    proxy_cache_valid 200 24h;

    # Canary TTL
    if ($okome_canary_mode = "canary") {
        proxy_cache_valid 200 5m;
        add_header X-OKOME-Canary "canary-ttl-5m" always;
    }

    proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
    add_header X-OKOME-Canary $okome_canary_mode always;
}

# Example: assets canary policy (cache key versioning)
location ~* ^/(assets|static)/ {
    proxy_pass http://okome_orchestrator;

    if ($okome_canary_mode = "debug") {
        proxy_no_cache 1;
        proxy_cache_bypass 1;
        add_header X-OKOME-Canary "debug-bypass" always;
        break;
    }

    proxy_cache OKOME_FRONTEND;

    # Control key
    set $cache_key_suffix "v1";

    # Canary key
    if ($okome_canary_mode = "canary") {
        set $cache_key_suffix "v2";
    }

    proxy_cache_key "$scheme$proxy_host$request_uri:$cache_key_suffix";
    proxy_cache_valid 200 7d;
    proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;

    add_header X-OKOME-Canary $okome_canary_mode always;
    add_header X-OKOME-Cache-Key-Suffix $cache_key_suffix always;
    access_log off;
}
