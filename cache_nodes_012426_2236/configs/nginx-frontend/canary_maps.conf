# Canary cache policy maps
# Include this file in Nginx config before server block
#
# Determines canary mode from header or cookie

# Canary selector: header takes precedence, then cookie, else "control"
map $http_x_okome_canary $canary_mode {
    default "control";
    "~^(control|canary|debug)$" $http_x_okome_canary;
}

map $http_cookie $canary_cookie_mode {
    default "";
    "~*okome_canary=(control|canary|debug)" $1;
}

# Resolve final canary mode
map "$canary_mode:$canary_cookie_mode" $okome_canary_mode {
    default $canary_mode;
    "~^control:(control|canary|debug)$" $canary_cookie_mode;
}
