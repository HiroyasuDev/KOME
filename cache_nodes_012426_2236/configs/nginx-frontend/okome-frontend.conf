# OKOME Frontend Cache Node — Path through OKOME (192.168.86.25) only
# Location: /etc/nginx/sites-available/okome-frontend
# Node: 192.168.86.20
# All traffic goes through OKOME at .25; OKOME handles GPU (.30) internally.
# Tuned for full throughput and all failure modes.

proxy_cache_path /var/cache/nginx/okome
    levels=1:2
    keys_zone=OKOME_FRONTEND:100m
    max_size=2g
    inactive=24h
    use_temp_path=off;

# Single upstream: OKOME at 192.168.86.25 (path through OKOME only)
upstream okome_upstream {
    server 192.168.86.25:8000 max_fails=3 fail_timeout=10s;
    keepalive 64;
}

server {
    listen 80;
    server_name _;

    add_header X-Cache-Status $upstream_cache_status always;
    add_header X-OKOME-Node frontend-cache always;
    add_header X-Upstream $upstream_addr always;

    # ---------- API / STREAMING — through OKOME .25, unbuffered, long timeouts ----------
    # /v1/*, /api/*, /execute, /agent, /run, /ws — no cache, no buffering, full throughput
    location ~* ^/(v1/|api/|execute|agent|run|ws) {
        proxy_pass http://okome_upstream;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";

        proxy_buffering off;
        proxy_request_buffering off;
        proxy_cache off;
        chunked_transfer_encoding on;

        proxy_connect_timeout 5s;
        proxy_read_timeout 600s;
        proxy_send_timeout 600s;

        proxy_next_upstream error timeout http_502 http_503 http_504;
        proxy_next_upstream_tries 2;
        proxy_next_upstream_timeout 10s;
    }

    # ---------- STATIC UI — cache allowed, stale on failure ----------
    location / {
        proxy_pass http://okome_upstream;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Connection "";

        proxy_cache OKOME_FRONTEND;
        proxy_cache_valid 200 24h;
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
        proxy_cache_lock on;
        proxy_cache_lock_timeout 5s;
        expires 24h;

        proxy_connect_timeout 5s;
        proxy_read_timeout 60s;
        proxy_send_timeout 60s;

        proxy_intercept_errors on;
        error_page 502 503 504 = @okome_maintenance;
    }

    # ---------- ASSETS — cache, long TTL ----------
    location ~* ^/(assets|static|ui-schema)/ {
        proxy_pass http://okome_upstream;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header Connection "";

        proxy_cache OKOME_FRONTEND;
        proxy_cache_valid 200 7d;
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
        expires 7d;
        access_log off;

        proxy_connect_timeout 5s;
        proxy_read_timeout 30s;
    }

    # ---------- VERSION / HEALTH — short cache ----------
    location ~* ^/(version|health)$ {
        proxy_pass http://okome_upstream;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header Connection "";

        proxy_cache OKOME_FRONTEND;
        proxy_cache_valid 200 5m;
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;

        proxy_connect_timeout 3s;
        proxy_read_timeout 5s;
    }

    # ---------- MAINTENANCE (when OKOME .25 unhealthy and no stale) ----------
    location @okome_maintenance {
        add_header Cache-Control "no-store" always;
        add_header Retry-After 30 always;
        default_type text/plain;
        return 503 "OKOME (192.168.86.25) unavailable. Retry shortly.\n";
    }

    # Default proxy headers
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Connection "";
}
