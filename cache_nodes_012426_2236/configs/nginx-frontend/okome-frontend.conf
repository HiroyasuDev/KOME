# OKOME Frontend/Edge Cache â€“ Nginx
# Frontend node: 192.168.86.20 (CN00)
# Upstream: 192.168.86.25:8000 (OKOME Orchestrator)
# Plan: okome_two-node_cache_architecture_implementation

upstream kome_orchestrator {
    server 192.168.86.25:8000 max_fails=3 fail_timeout=10s;
    keepalive 32;
}

proxy_cache_path /var/cache/nginx/okome
    levels=1:2
    keys_zone=OKOME:100m
    inactive=24h
    max_size=2g
    use_temp_path=off;

limit_req_zone $binary_remote_addr zone=ui_limit:10m rate=20r/s;
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=5r/s;

server {
    listen 80;
    server_name okome.local;

    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/json application/xml;

    location ~ ^/(assets|ui-schema|version)/ {
        limit_req zone=ui_limit burst=40 nodelay;
        proxy_pass http://kome_orchestrator;
        proxy_cache OKOME;
        proxy_cache_valid 200 24h;
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
        proxy_cache_background_update on;
        add_header X-Cache-Status $upstream_cache_status;
        add_header X-OKOME-Node "frontend-192.168.86.20";
        add_header X-Cache-Key $scheme$proxy_host$request_uri;

        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Connection "";
    }

    location / {
        limit_req zone=api_limit burst=15 nodelay;
        proxy_pass http://kome_orchestrator;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Connection "";

        proxy_connect_timeout 5s;
        proxy_send_timeout 10s;
        proxy_read_timeout 10s;
    }
}
